#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
MongoDB数据库初始化脚本

这个脚本用于初始化MongoDB数据库。
"""

import os
import sys
import asyncio

# 添加项目根目录到Python路径
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.db.session import get_database

{% if include_auth %}
from app.utils.security import get_password_hash
{% endif %}


async def init_db():
    """
    初始化数据库
    """
    db = get_database()
    
    # 创建索引
    # 示例：await db.collection.create_index([("field_name", 1)], unique=True)
    
    {% if include_auth %}
    # 创建管理员用户
    users_collection = db.users
    
    # 检查是否已存在管理员用户
    admin = await users_collection.find_one({"email": "admin@example.com"})
    if not admin:
        await users_collection.insert_one({
            "email": "admin@example.com",
            "username": "admin",
            "hashed_password": get_password_hash("admin"),
            "is_active": True,
            "is_superuser": True
        })
        print("管理员用户已创建")
    else:
        print("管理员用户已存在")
    {% endif %}
    
    print("数据库初始化完成")


if __name__ == "__main__":
    asyncio.run(init_db())