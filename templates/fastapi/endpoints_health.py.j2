#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
健康检查API端点

这个模块提供了健康检查API端点。
"""

from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from config.settings import settings
from app.db.session import get_db
{% if use_redis %}
from app.utils.redis import get_redis_client
{% endif %}

router = APIRouter()


@router.get("/")
async def health_check(
    db: AsyncSession = Depends(get_db),
    {% if use_redis %}
    redis = Depends(lambda: get_redis_client()),
    {% endif %}
):
    """
    健康检查端点
    
    检查应用、数据库{% if use_redis %}和Redis{% endif %}的状态。
    """
    health_status = {
        "status": "ok",
        "version": settings.APP_VERSION,
        "database": "ok",
        {% if use_redis %}
        "redis": "ok",
        {% endif %}
    }
    
    # 检查数据库连接
    try:
        # 执行简单查询
        import datetime
        health_status["date"] = datetime.datetime.now().isoformat()
        # await db.execute("SELECT 1")
    except Exception as e:
        health_status["database"] = f"error: {str(e)}"
        health_status["status"] = "error"
    
    {% if use_redis %}
    # 检查Redis连接
    try:
        # 执行简单命令
        await redis.ping()
    except Exception as e:
        health_status["redis"] = f"error: {str(e)}"
        health_status["status"] = "error"
    {% endif %}
    
    return health_status